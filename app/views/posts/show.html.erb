<div class="min-h-screen bg-gray-900 text-white flex items-center justify-center p-6">
  <div class="bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-lg text-center">

    <!-- 曲情報 -->
    <%= image_tag @post.song.album_art_url,
        alt: "#{@post.song.title} のアルバムアート",
        class: "mx-auto w-32 h-32 rounded mb-4",
        loading: "lazy", decoding: "async" %>
    <h1 class="text-2xl font-bold"><%= @post.song.title %></h1>
    <p class="text-gray-400 mb-6"><%= @post.song.artist %></p>

    <!-- 投稿者ラベル -->
    <% if @post.user.present? %>
      <div class="mt-2 flex items-center justify-center text-sm text-gray-400 gap-2">
        <span>投稿者：</span>
        <%= link_to @post.user.nickname.presence || "ゲスト",
              user_path(@post.user),
              class: "text-purple-400 hover:underline" %>
        <%= image_tag avatar_variant_for(@post.user, size: 24),
              class: "h-6 w-6 rounded-full border border-gray-600 object-cover",
              width: 24, height: 24, loading: "lazy", decoding: "async", alt: "" %>       
      </div>
    <% end %>

    <!-- 思い出テキスト -->
    <div class="mt-6 bg-gray-700 p-4 rounded">
      <%= simple_format(@post.memory_text) %>
    </div>

    <!-- 選択したタグ表示 -->
    <% if @post.tags.any? %>
      <div class="mt-4 flex flex-wrap gap-2 text-sm justify-center">
        <% @post.tags.each do |tag| %>
          <%= link_to tag.name, tag_path(tag),
                class: "px-3 py-1 rounded-full bg-gray-800 border border-gray-600
                        text-gray-200 hover:bg-gray-700 transition" %>
        <% end %>
      </div>
    <% end %>

    <%# 共通ボタンクラス（見た目は変わらない） %>
    <% btn_base = "inline-flex items-center text-white px-4 py-2 rounded-lg shadow-md justify-center" %>

    <div class="flex flex-col items-center gap-4">
      <% if @post.song.spotify_id.present? %>
        <div class="mt-4 w-full max-w-md">
          <iframe
            title="Spotify preview"
            class="w-full rounded-xl"
            width="100%" height="80"
            src="https://open.spotify.com/embed/track/<%= @post.song.spotify_id %>?utm_source=generator"
            frameborder="0"
            allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
            loading="lazy">
          </iframe>
        </div>
      <% end %>

      <% hashtags = @post.tags
                      .limit(5)
                      .map { |t| "##{t.name.to_s.strip.gsub(/\s+/, '_').gsub(/[^0-9A-Za-z_ぁ-んァ-ヶ一-龠ー]/, '')}" }
                      .uniq
                      .join(' ') %>

      <% title  = @post.song&.title  || "Unknown Title" %>
      <% artist = @post.song&.artist || "Unknown Artist" %>

      <% share_text   = "MeloLogを投稿したよ！ #MeloLog\n#{hashtags}\n#{title} - #{artist}" %>
      <% encoded_text = ERB::Util.url_encode(share_text) %>
      <% encoded_url  = ERB::Util.url_encode(post_url(@post)) %>

      <a href="https://x.com/intent/tweet?text=<%= encoded_text %>&url=<%= encoded_url %>"
        target="_blank"
        rel="noopener noreferrer"
        aria-label="Xでシェアする"
        class="bg-blue-500 hover:bg-blue-600 <%= btn_base %>">
        <%= image_tag "x-logo.png", alt: "Xロゴ", size: "20x20" %>
        &ensp;でシェアする
      </a>
    </div>

    <!-- 再投稿リンク -->
    <div class="mt-6">
      <%= link_to "MeloLogを投稿する", new_post_path, class: "text-gray-400 hover:underline text-sm" %>
    </div>

    <!-- 追加部分：条件分岐で導線を出し分け -->
    <% if !logged_in? %>
      <div class="mt-10 border-t border-gray-700 pt-6 flex flex-col items-center gap-3">
        <p class="text-gray-300 mb-3 text-sm">
          ユーザー登録すると、投稿をマイページで管理できるよ！
        </p>
        <%= link_to "アカウントを作成",
            new_user_path,
            class: "text-purple-400 hover:underline text-sm" %>
      </div>
    <% end %>
  </div>
</div>
