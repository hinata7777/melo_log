<div class="min-h-screen bg-gray-900 text-white p-6">
  <div class="max-w-2xl mx-auto bg-gray-800 rounded-xl shadow p-6 space-y-5">
    <h1 class="text-xl font-bold text-center">テキストを編集</h1>

    <!-- ★ 選択中の曲を表示（詳細と統一） -->
    <% if @post&.song %>
      <div class="bg-gray-800 rounded-lg p-4 flex gap-4 items-center">
        <%= image_tag(@post.song.album_art_url, alt: "",
                      class: "h-20 w-20 rounded object-cover flex-shrink-0",
                      loading: "lazy", decoding: "async") %>

        <div class="min-w-0">
          <p class="font-bold truncate">
            <%= @post.song.title %> - <span class="text-gray-300"><%= @post.song.artist %></span>
          </p>
          <div class="mt-1">
            <%= link_to "Spotifyで聴く", @post.song.spotify_url,
                        target: "_blank", rel: "noopener",
                        class: "text-green-400 hover:text-green-300 text-sm" %>
          </div>
        </div>
      </div>
    <% end %>

    <%= form_with model: @post, url: post_path(@post, page: params[:page]), method: :patch do |f| %>
      <%= f.text_area :memory_text, rows: 6,
            class: "w-full rounded-lg bg-gray-900 border border-gray-700 p-3 text-sm text-gray-100" %>

      <!-- タグ選択・編集 -->
      <div class="mt-4 mb-2 flex flex-wrap justify-center -m-1">
        <%= f.hidden_field :tag_ids, value: [], multiple: true %>
        <%= f.collection_check_boxes :tag_ids, Tag.where(active: true).order(:name), :id, :name, include_hidden: false do |b| %>
          <%= b.label class: "m-1 inline-flex" do %>
            <%= b.check_box class: "sr-only peer" %>
            <span class="inline-flex items-center whitespace-nowrap
                        px-4 py-2 rounded-full border border-gray-400 text-gray-300
                        peer-checked:bg-blue-500 peer-checked:text-white peer-checked:border-blue-500
                        transition">
              <%= b.text %>
            </span>
          <% end %>
        <% end %>
      </div>
      
      <% if @post.errors.any? %>
        <ul class="mt-2 text-sm text-red-300">
          <% @post.errors.full_messages.each do |m| %><li><%= m %></li><% end %>
        </ul>
      <% end %>

      <div class="mt-4 flex gap-2">
        <%= f.submit "保存", class: "px-3 py-1.5 rounded bg-purple-600 hover:bg-purple-500 text-white text-sm" %>
        <%= link_to "キャンセル", user_path(@post.user, page: params[:page]),
              class: "px-3 py-1.5 rounded bg-gray-700 hover:bg-gray-600 text-sm" %>
        <%= link_to "投稿詳細へ", post_path(@post),
              class: "px-3 py-1.5 rounded bg-gray-700 hover:bg-gray-600 text-sm ml-auto" %>
      </div>
    <% end %>
  </div>
</div>
