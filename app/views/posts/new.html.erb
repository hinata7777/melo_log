<div class="bg-gray-900 text-white flex items-center justify-center p-6">
  <div class="bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-lg text-center">
    <h1 class="text-2xl font-bold mb-6">MeloLogを投稿する</h1>

    <!-- エラー文 -->
    <% if @post&.errors&.any? %>
      <div class="bg-red-900/40 text-red-100 rounded p-3 mb-4">
        <ul class="list-none pl-0">
          <% @post.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <!-- 検索フォーム -->
    <%= form_with url: search_songs_path, method: :get, data: { turbo_frame: "search_results" }, class: "mb-6" do |f| %>
      <div class="flex justify-center mb-3">
        <%= f.text_field :q, placeholder: "曲名やアーティスト名",
                         class: "p-2 rounded w-64 bg-gray-900 border border-white text-white placeholder-gray-400 mr-2" %>
        <%= f.submit "検索", class: "bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded" %>
      </div>
    <% end %>

    <!-- Turbo Frame: 検索結果表示 -->
    <%= turbo_frame_tag "search_results" do %>
      <!-- 検索前は空 -->
    <% end %>

    <!-- 選択した曲プレビュー -->
    <div id="selected-song" class="mt-6 bg-gray-700 rounded-lg p-4 shadow-md flex items-center">
      <!-- 未選択時のメッセージ --> 
      <p id="no-selection" class="text-gray-300 text-sm w-full text-center">まだ曲が選択されていません</p>

      <!-- 選択後に表示する部分（初期はhidden） -->
      <div id="song-preview" class="hidden flex flex-col items-center w-full">
        <p class="text-gray-300 text-sm mb-2">選択中の曲</p>

        <div class="flex items-center">
          <img id="preview-art" class="w-16 h-16 rounded mr-4">
          <div class="text-left">
            <p id="preview-title" class="font-bold text-white"></p>
            <p id="preview-artist" class="text-gray-300 text-sm"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- 投稿フォーム -->
    <%= form_with model: @post, url: posts_path, class: "mt-6" do |f| %>
      <!-- 曲情報をhiddenで送信 -->
      <%= hidden_field_tag :spotify_id, nil, data: { turbo_permanent: true } %>
      <%= hidden_field_tag :title, nil, data: { turbo_permanent: true } %>
      <%= hidden_field_tag :artist, nil, data: { turbo_permanent: true } %>
      <%= hidden_field_tag :album_art_url, nil, data: { turbo_permanent: true } %>
      <%= hidden_field_tag :spotify_url, nil, data: { turbo_permanent: true } %>

      <%= f.text_area :memory_text, placeholder: "この曲の思い出を書こう（300文字以内）",
                       class: "w-full p-3 rounded bg-gray-900 border border-white text-white placeholder-gray-400 mb-2" %>
      
      <!-- タグ選択・編集 -->
      <% has_resident = logged_in? && @resident_tags.present? %>
      <% has_event   = @event_tags.present? %>

      <% if has_resident || has_event %>
        <div class="mb-2 space-y-4">
          <!-- まず隠しフィールド：何も選ばなくても param 形を維持 -->
          <%= f.hidden_field :tag_ids, value: [], multiple: true %>
          <!-- 常駐タグ（ログイン時のみ表示・選択可） -->
          <% if logged_in? %>
            <div>
              <p class="block text-sm text-gray-400 mb-2">タグ（複数選択可）</p>
              <div class="mt-4 flex flex-wrap justify-center -m-1">
                <%= f.collection_check_boxes :tag_ids, @resident_tags, :id, :name, include_hidden: false do |b| %>
                  <%= b.label class: "m-1 inline-flex" do %> 
                    <%= b.check_box class: "sr-only peer" %> 
                    <span class="inline-flex items-center whitespace-nowrap
                                px-4 py-2 rounded-full border border-gray-400 text-gray-300
                                peer-checked:bg-blue-500 peer-checked:text-white peer-checked:border-blue-500
                                transition">
                      <%= b.text %>
                    </span>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>
          <!-- イベントタグ（誰でも選べる） -->
          <% if has_event %>
            <div>
              <p class="block text-sm text-gray-400 mb-2">イベントタグ</p>
              <div class="mt-4 flex flex-wrap justify-center gap-2">
                <%= f.collection_check_boxes :tag_ids, @event_tags, :id, :name, include_hidden: false do |b| %>
                  <%= b.label class: "cursor-pointer" do %>
                    <%= b.check_box(class: "hidden peer") %>
                    <span class="px-4 py-2 rounded-full border border-gray-400 text-gray-300
                                peer-checked:bg-blue-500 peer-checked:text-white peer-checked:border-blue-500 transition">
                      <%= b.text %>
                    </span>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
      <%= f.submit "投稿する", class: "mt-6 bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg shadow-md" %>
    <% end %>

    <% unless logged_in? %>
      <div class="mt-10 border-t border-gray-700 pt-6 flex flex-col items-center gap-2 text-center">
        <p class="text-gray-400 text-xs">
          ユーザー登録すると様々な機能が楽しめるよ！<br>・マイページでの投稿管理<br>・ハッシュタグ付き投稿
        </p>
        <%= link_to "アカウントを作成",
            new_user_path,
            class: "text-purple-400 hover:underline text-sm mt-2" %>
      </div>
    <% end %>
  </div>
</div>
